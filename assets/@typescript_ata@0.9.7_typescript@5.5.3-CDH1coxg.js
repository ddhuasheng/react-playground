var S=Object.defineProperty,I=Object.defineProperties,R=Object.getOwnPropertyDescriptors,N=Object.getOwnPropertySymbols,q=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,D=(e,r,t)=>r in e?S(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,k=(e,r)=>{for(var t in r||(r={}))q.call(r,t)&&D(e,t,r[t]);if(N)for(var t of N(r))K.call(r,t)&&D(e,t,r[t]);return e},V=(e,r)=>I(e,R(r)),m=(e,r,t)=>new Promise((o,l)=>{var n=a=>{try{d(t.next(a))}catch(c){l(c)}},i=a=>{try{d(t.throw(a))}catch(c){l(c)}},d=a=>a.done?o(a.value):Promise.resolve(a.value).then(n,i);d((t=t.apply(e,r)).next())}),z=(e,r)=>{const t=`https://data.jsdelivr.com/v1/package/npm/${r}`;return g(e,t,{cache:"no-store"})},A=(e,r,t)=>{const o=`https://data.jsdelivr.com/v1/package/resolve/npm/${r}@${t}`;return g(e,o)},B=(e,r,t)=>m(void 0,null,function*(){const o=`https://data.jsdelivr.com/v1/package/npm/${r}@${t}/flat`,l=yield g(e,o);return l instanceof Error?l:V(k({},l),{moduleName:r,version:t})}),T=(e,r,t,o)=>m(void 0,null,function*(){const l=`https://cdn.jsdelivr.net/npm/${r}@${t}${o}`,i=yield(e.fetcher||fetch)(l);return i.ok?i.text():new Error("OK")});function g(e,r,t){return(e.fetcher||fetch)(r,t).then(l=>l.ok?l.json().then(n=>n):new Error("OK"))}var G=e=>{const r=["assert","assert/strict","async_hooks","buffer","child_process","cluster","console","constants","crypto","dgram","diagnostics_channel","dns","dns/promises","domain","events","fs","fs/promises","http","http2","https","inspector","inspector/promises","module","net","os","path","path/posix","path/win32","perf_hooks","process","punycode","querystring","readline","repl","stream","stream/promises","stream/consumers","stream/web","string_decoder","sys","timers","timers/promises","tls","trace_events","tty","url","util","util/types","v8","vm","wasi","worker_threads","zlib"];if(e.indexOf("node:")===0||r.includes(e))return"node";const[t="",o=""]=e.split("/");return t.startsWith("@")?`${t}/${o}`:t},U=e=>{const r=new Map,t=new Map;let o=0,l=0;return i=>(o=0,l=0,n(i,0).then(d=>{var a,c;l>0&&((c=(a=e.delegate).finished)==null||c.call(a,t))}));function n(i,d){return m(this,null,function*(){var a,c,F,w,P;const M=J(e,r,i);M.forEach(s=>r.set(s.module,{state:"loading"}));const h=(yield Promise.all(M.map(s=>E(e,s.module,s.version)))).filter(s=>!("error"in s)),O=h.filter(s=>s.files.find(u=>$(u.name))),x=O.map(s=>j(s,`/node_modules/${s.moduleName}`)),C=h.filter(s=>!O.includes(s)),b=(yield Promise.all(C.map(s=>E(e,`@types/${y(s.moduleName)}`,"latest")))).filter(s=>!("error"in s)),W=b.map(s=>j(s,`/node_modules/@types/${y(s.moduleName).replace("types__","")}`)),_=x.concat(W).reduce((s,u)=>s.concat(u),[]);o+=_.length,_.length&&d===0&&((c=(a=e.delegate).started)==null||c.call(a));for(const s of h){let u=`/node_modules/${s.moduleName}`;b.includes(s)&&(u=`/node_modules/@types/${y(s.moduleName).replace("types__","")}`);const f=u+"/package.json",p=yield T(e,s.moduleName,s.version,"/package.json");typeof p=="string"?(t.set(f,p),(w=(F=e.delegate).receivedFile)==null||w.call(F,p,f)):(P=e.logger)==null||P.error(`Could not download package.json for ${s.moduleName}`)}yield Promise.all(_.map(s=>m(this,null,function*(){var u,f,p;const v=yield T(e,s.moduleName,s.moduleVersion,s.path);l++,v instanceof Error?(u=e.logger)==null||u.error(`Had an issue getting ${s.path} for ${s.moduleName}`):(t.set(s.vfsPath,v),(p=(f=e.delegate).receivedFile)==null||p.call(f,v,s.vfsPath),e.delegate.progress&&l%5===0&&e.delegate.progress(l,o),yield n(v,d+1))})))})}};function j(e,r){const t=[];for(const o of e.files)$(o.name)&&t.push({moduleName:e.moduleName,moduleVersion:e.version,vfsPath:`${r}${o.name}`,path:o.name});return t}var H=(e,r)=>{const t=e.preProcessFile(r),o=e.libMap||new Map;return t.referencedFiles.concat(t.importedFiles).concat(t.libReferenceDirectives).filter(n=>!$(n.fileName)).filter(n=>!o.has(n.fileName)).map(n=>{let i;if(!n.fileName.startsWith(".")){i="latest";const d=r.slice(n.end).split(`
`)[0];d.includes("// types:")&&(i=d.split("// types: ")[1].trim())}return{module:n.fileName,version:i}})};function J(e,r,t){return H(e.typescript,t).map(n=>V(k({},n),{module:G(n.module)})).filter(n=>!n.module.startsWith(".")).filter(n=>!r.has(n.module))}var E=(e,r,t)=>m(void 0,null,function*(){let o=t||"latest";if(o.split(".").length<2){const n=yield A(e,r,o);if(n instanceof Error)return{error:n,userFacingMessage:`Could not go from a tag to version on npm for ${r} - possible typo?`};const i=n.version;if(!i){const d=yield z(e,r);if(d instanceof Error)return{error:n,userFacingMessage:`Could not get versions on npm for ${r} - possible typo?`};const a=Object.entries(d.tags).join(", ");return{error:new Error("Could not find tag for module"),userFacingMessage:`Could not find a tag for ${r} called ${t}. Did find ${a}`}}o=i}const l=yield B(e,r,o);return l instanceof Error?{error:l,userFacingMessage:`Could not get the files for ${r}@${o}. Is it possibly a typo?`}:l});function y(e){return e.indexOf("@")===0&&e.indexOf("/")!==-1&&(e=e.substr(1).replace("/","__")),e}function $(e){return/\.d\.([^\.]+\.)?[cm]?ts$/i.test(e)}export{U as s};
